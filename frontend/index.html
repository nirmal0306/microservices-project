<!DOCTYPE html>
<html>
<head>
  <title>Dealer Evaluation</title>
</head>
<body>
  <h1>Dealer Evaluation</h1>

  <label for="products">Select Product:</label>
  <select id="products">
    <option value="" disabled selected>Select Product</option>
  </select>

  <br><br>

  <label for="dealers">Select Dealer:</label>
  <select id="dealers">
    <option value="" disabled selected>Select Dealer</option>
  </select>

  <h3><pre id="price"></pre></h3> <!-- Using <pre> so multiple lines show nicely -->

  <script>
    const productAPI = "https://product-service-4lwd.onrender.com/products";
    const pricingAPI = "https://dealer-service-o0ej.onrender.com/pricing/"; // trailing slash

    let currentDealers = []; // store current product's dealers

    async function loadProducts() {
      let res = await fetch(productAPI);
      let products = await res.json();
      let productSelect = document.getElementById("products");
      productSelect.innerHTML = '<option value="" disabled selected>Select Product</option>';

      products.forEach(p => {
        let option = document.createElement("option");
        option.value = p.id;
        option.textContent = p.name;
        productSelect.appendChild(option);
      });

      resetDealers();
    }

    async function loadDealers() {
      let productId = document.getElementById("products").value;
      if (!productId) return;

      let res = await fetch(pricingAPI + productId);
      let dealers = await res.json();
      currentDealers = dealers;

      let dealerSelect = document.getElementById("dealers");
      dealerSelect.innerHTML = '<option value="" disabled selected>Select Dealer</option>';

      dealers.forEach(d => {
        let option = document.createElement("option");
        option.value = d.price;
        option.textContent = d.dealer;
        dealerSelect.appendChild(option);
      });

      // Add "All Dealers" option if more than one dealer
      if (dealers.length > 1) {
        let allOption = document.createElement("option");
        allOption.value = "all";
        allOption.textContent = "All Dealers";
        dealerSelect.appendChild(allOption);
      }

      showPrice();
    }

    function showPrice() {
      let dealerSelect = document.getElementById("dealers");
      let selectedValue = dealerSelect.value;
      let priceElement = document.getElementById("price");

      if (!selectedValue) {
        priceElement.innerText = "";
      } else if (selectedValue === "all") {
        // Show all dealers with their prices
        let allPrices = currentDealers.map(d => `${d.dealer}: $${d.price}`).join("\n");
        priceElement.innerText = allPrices;
      } else {
        // Show selected dealer name and price
        let dealerName = dealerSelect.options[dealerSelect.selectedIndex].text;
        priceElement.innerText = `${dealerName}: $${selectedValue}`;
      }
    }

    function resetDealers() {
      let dealerSelect = document.getElementById("dealers");
      dealerSelect.innerHTML = '<option value="" disabled selected>Select Dealer</option>';
      document.getElementById("price").innerText = "";
      currentDealers = [];
    }

    document.getElementById("products").addEventListener("change", loadDealers);
    document.getElementById("dealers").addEventListener("change", showPrice);

    loadProducts();
  </script>
</body>
</html>
